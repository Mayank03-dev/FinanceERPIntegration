<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
  <sys_script_include action="INSERT_OR_UPDATE">
    <access>public</access>
    <active>true</active>
    <api_name>sn_fcms_intg.PostPurchaseOrderService</api_name>
    <caller_access/>
    <client_callable>false</client_callable>
    <description/>
    <name>PostPurchaseOrderService</name>
    <script><![CDATA[var PostPurchaseOrderService = Class.create();

PostPurchaseOrderService.sendPO = function(erpSourceId,orderGr){
	var result = {};
	var erpConfig = new sn_fcms_intg.ErpSourceConfig(erpSourceId);
	var erpConfigId = erpConfig.getValue('sys_id');
	if( !erpConfig.isValid() || !erpConfig.hasValidService(SpendIntgConstants.ERP_SERVICE_POST_PO) ) {
		result.status = IntgConstants.STATUS_FAIL;
		result.message = gs.getMessage("Integration not setup");
		return result;
	}
	var input = {};
	input.sn_shop_purchase_order= "sys_id=" + orderGr.sys_id;
	var requisitionId = orderGr.getValue('purchase_requisition');
	var context = {"erp_source": erpSourceId,
				  "erp_config": erpConfigId,
				  "requisition_id": requisitionId};
	var response = sn_fcms_intg.ErpIntegrator.doService(SpendIntgConstants.ERP_SERVICE_POST_PO,
											 erpConfig, 
											 input, 
											 context);

	if(response.status != IntgConstants.STATUS_SUCCESS)
		gs.error("Error in posting purchase order data for " + erpConfig.getValue('name'));
	return response;
};

PostPurchaseOrderService.handleResponse = function(result){
	var response = result.response;
	var status = response.status;
	var context = result.context;
	
	if (status != 200){
		sn_shop.SpendTaskUtil.createPOIntegrationErrorTask(context.requisition_id, response.error.error_message);
		new sn_shop.PurchaseRequisitionUtil(requisitionId).updatePostedToERPFlagOfPurchaseRequisition('failed');
	}
	
};

PostPurchaseOrderService.prototype = {
    initialize: function() {
    },

    type: 'PostPurchaseOrderService'
};]]></script>
    <sys_class_name>sys_script_include</sys_class_name>
    <sys_created_by>admin</sys_created_by>
    <sys_created_on>2019-12-19 15:28:14</sys_created_on>
    <sys_id>ae773f3db77100104c16f238ee11a9ab</sys_id>
    <sys_mod_count>16</sys_mod_count>
    <sys_name>PostPurchaseOrderService</sys_name>
    <sys_package display_value="Finance - ERP Integration" source="sn_fcms_intg">0b4eadd1531113008f12ddeeff7b126d</sys_package>
    <sys_policy>read</sys_policy>
    <sys_scope display_value="Finance - ERP Integration">0b4eadd1531113008f12ddeeff7b126d</sys_scope>
    <sys_update_name>sys_script_include_ae773f3db77100104c16f238ee11a9ab</sys_update_name>
    <sys_updated_by>admin</sys_updated_by>
    <sys_updated_on>2020-04-16 13:16:24</sys_updated_on>
  </sys_script_include>
</record_update>
